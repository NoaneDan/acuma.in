# Facebook Photo Import:
***
## Description:
Import photos from an event, by searching the event page for images
uploaded by the admin and the albums from the page of the location which
have a similar name to the one of the event.
***
## Create an importer:
To create an importer call the constructor with the following
parameters:
+ **event_id** - the Facebook ID of the event, returned by FacebookEventImport.
+ **location_id** - the Facebook ID of the location where the event takes
place, returned by FacebookLocationImport.
+ **access token** - string, generated by FacebookAuth.

The generated app access token expires in 60 days. When it expires all
the responses from the API will have a status code of *400* and will
contain:

    `{
        "error": {
            "message": "Error validating access token: Session has expired at unix 
                        time SOME_TIME. The current unix time is SOME_TIME.", 
            "type": "OAuthException", 
            "code": 190
        }
    }`
***
## Get photos:
To import photos you must call the **getPhotos()** method.
This method calls **getEventPhotos()**, which will import the photos
from the event page, and then calls **getLocationPhotos()** which searches
the albums from the page of the location which have a similar name to the one
of the event.
***
## Get event photos:
This method imports photos from an event or an album. It takes one
optional parameter which represents the source. If no parameter is
given then it will be set to the id of the event.

    `if (!isset($from)) {
        $from = $this->event_id;
    }`

The method will make a **GET** request to Facebook Graph API for
images at ***'https://graph.facebook.com/v2.7/{event_id/location_id}/photos'***.

The query parameters required for the first request are:

    `'query' => [
        'access_token' => $this->access_token,
        'fields' => 'images'
    ]`
    
Where:
+ **fields** - what you want to extract. In this case *'images'*.

The photos are returned in reverse chronological order.
The list of photos is on one or more pages, each containing the url
of the next one. To check if there is another page the script verifies
if the *paging* memeber of the object returned by Facebook Graph API
has the *next* memeber set. If it is set it will be a *url* to the next page.
This *url* is parsed in order to extract the *after* parameter and the
*limit* parameter, which represents the maximum number of photos on
the next page.
*after* and *limit* are added to the query and the request for the
next page is made.

The *after* parameter tells Graph API to return on the next page only photos
that are 'after' (in reverse chronological order) the last one on the previous
page.

    `// the photos are on multiple pages
    // we are given the url of the next page, if exists
    if (isset($photos->paging->next)) {
        $url = parse_url($photos->paging->next);
        parse_str($url['query']);
                
        $params['query']['after'] = $after;
        $params['query']['limit'] = $limit;
        if (isset($pretty)) {
            $params['query']['pretty'] = $pretty;
        }
    }`
    
This is repeated as long as there are more pages (the *next* member of *paging*
is set).

The response contains a **JSON** object. The list of photos is in the **data**
member of this object. A photo is represented as a list of images ordered
descending by their resolution.
***
## Process photos:
The **processPhotos()** method is called by **getEventPhotos()** after a list of
photos is returned.
This method saves the *url* to the image with the biggest resolution of a photo:

    `$processed_photo = [
        'photo_url' => $photo->images[0]->source  
    ];`
    
*images* is a list of images ordered descending by resolution.
***
## Add to database:
**addToDB()** is called by **getEventPhotos()** after a list of photos
is processed.
Every photo is saved to the database if it isn't already there.
***
## Get location photos:
This method looks through the albums found on the page of the location
where the event took place and tries to find an album who's name is
similar to the name of the event.
If the album was found previously it will call **getEventPhotos()** with
the id of the album.

The algorithm makes a **GET** request to Facebook Graph API at
***'https://graph.facebook.com/v2.7/{location_id}/albums'***
for the list of albums.

The albums are also on multiple pages and the process of getting the
next page is the same as in the case of photos described above.

The list of albums returned is sorted in reverse chronological order,
except for a few, such as 'Profile Pictures', 'Timeline Photos',
'Cover Photos' and 'Mobile Uploads'. These are usually somewhere on the first page.
The script stops searching for albums when the current album was created earlier than
the start date of the event.

    `// the albums are stored in chronological order except for a few (Profile Pictures, Timline Photos, etc.)
    if (strtotime($album->created_time) < strtotime($event->start_time) && !in_array($album->name, ['Profile Pictures', 'Timeline Photos', 'Cover Photos', 'Mobile Uploads'])) {
        $old_albums = true;
    }`
    
It finds similar names by comparing the metaphones of the names using the **similar_text** function.
This function takes 3 parameters: two names and a variable in which it will store the perecentage
of similarity. The **metaphone** function creates the same key for similar sounding words. This
reduces slightly the small diferences between the name of the event and the name of the album.

    `// try to find a match between the album name and the event
    similar_text(metaphone($album->name), metaphone($event->name), $percentage);
    if ((!isset($max_percentage)) || ($percentage > $max_percentage)) {
        $album_id = $album->id;
        $max_percentage = $percentage;
    }`
    
A satisfying match is found when the percentage of similarity is bigger than 70.

    `// if we find a satisfying match we save the album id
    // and extract the photos from it
    if ($max_percentage > 70) {
        $event = ORM::for_table('fb_event')
            ->where('event_id', $this->event_id)
            ->find_one();
                    
        $event->album_id = $album_id;
        $event->save();
                
        $this->getEventPhotos($album_id);
    }`

After a match is found the **getEventPhotos()** method is called with the id of the album.