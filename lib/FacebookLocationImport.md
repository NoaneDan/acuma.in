# Facebook Location Import:
***
## Description:
Searches for Facebook places in a given area. The area is given by
a coordinate point and a radius in meters (between 0 and 50000).
***
## Create a new importer:
To create a new importer you must call the constructor with the
following parameters:
+ **latitude**
+ **longitude**
+ **radius**
+ **access token** - string, generated by FacebookAuth.

The generated app access token expires in 60 days. When it expires all
the responses from the API will have a status code of *400* and will
contain:

    `{
        "error": {
            "message": "Error validating access token: Session has expired at unix 
                        time SOME_TIME. The current unix time is SOME_TIME.", 
            "type": "OAuthException", 
            "code": 190
        }
    }`
***
## Get locations:
To search for locations you must call the **getLocations()** method.
This will make a **GET** request to Facebook Graph API at
***'https://graph.facebook.com/v2.7/search'*** with the following
query parameters:

    `'query' => [
        'q' => '',
        'type' => 'place',
        'center' => "$this->latitude,$this->longitude",
        'distance' => $this->radius,
        'access_token' => $this->access_token
    ]`
    
Where:
+ **q** - query string, this must be set if you want locations that
contain some keywords in their name.
+ **type** - the type of thing that we want to search for. In this
case we want to search for a *place*.
+ **center** - the coordinate point as *{latitude},{longitude}*.
+ **distance** - the maximum distance at which a location could be
from the center point.

The list of locations is divided in multiple pages, each containing
by default 25 locations. The script makes a request for each page.

The first page is at *offset* 0, so the offset parameter is not added
in the query when making the first request.

To find if there are multiple pages check if the *paging* member of
the object returned by the API (as **JSON** string) has the *next*
member set. If it is set it will be a *url* to the next page.
This *url* is parsed in order to extract the *offset* of the next
page and the *limit* parameter, which represents the maximum number of
locations on the next page.
The *offset* and *limit* are added to the query and the request for the
next page is made.
This is repeated as long as there are more pages (the *next* member of *paging*
is set).

    `// the location are on multiple 'pages'
    // we are given the url of the next page, if exists
    if (isset($locations->paging->next)) {
        $url = parse_url($locations->paging->next);
        parse_str($url['query']);
                
        $params['query']['limit'] = $limit;
        $params['query']['offset'] = $offset;
    }`

The response body is a **JSON** object containing a list of locations
in the **data** member.
***
## Add to database:
After every successful request **getLocations()** calls the **addToDB()**
method, with the *JSON* object returned by Facebook Graph API, to save
the locations to the database.

The method saves the location to the database, except the ones that
are already there.